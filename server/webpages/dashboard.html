<!DOCTYPE html>
<html>
    <head></head>
    <body>
        <canvas id="myCanvas" width="220" height="220" style="background-color:darkblue">
        </canvas>

        <div id="textUnits" style ="background-color:darkgray">
            Available units:<br>
        </div>
        
        <div id="textQueue" style ="background-color:lightgray">
            Queue:<br>
        </div>

        <br>

        <div id="fieldSend" style ="background-color:darkgray">
            Send <input type="text" id="inputSendUnit" size="6"> to location <input type="text" id="inputSendLocation" size="6"><button onclick="SendLocation()">Send command</button>
        </div>

        <div id="fieldDeliver" style ="background-color:lightgray">
            Pickup from <input type="text" id="inputPickupLocation" size="6"> and deliver to <input type="text" id="inputDeliverLocation" size="6"><button onclick="SendPickup()">Add to queue</button>
        </div>
        
        <div id="fieldStop" style ="background-color:darkgray">
            <button onclick="Stop()">Stop</button>
        </div>

        <br>

        <div id="textDebug" style ="background-color:lightgray">
            Debug: <br>
        </div>
        <div id="myDiv" style ="background-color:lightgray">

        </div>

        <script>
            // Websocket connection with server
            let data;
            let ws = new WebSocket("ws://145.24.222.80:8008");

            function get_data() {
                ws.send("request_messages");
            }
            
            ws.onmessage = function(message) {
                data = JSON.parse(message.data);
                // Do something with the data
                document.getElementById("myDiv").innerHTML = JSON.stringify(data);

                UpdateCanvas();
                UpdateUnits();
                UpdateQueue();
            }
            
            setInterval(get_data, 1000);
        

            // Canvas
            CanvasRenderingContext2D.prototype.clear = function() {
                this.clearRect (0, 0, this.canvas.width, this.canvas.height);
            };
            CanvasRenderingContext2D.prototype.drawBlock = function(x, y) {
                this.fillRect(20*x, 20*y, 20, 20) ;
            }
            
            let myCanvas = document.getElementById("myCanvas").getContext("2d");
            
            function UpdateCanvas() {
                myCanvas.clear();

                // Obstacles
                myCanvas.fillStyle = "brown";
                let obstacles = data["obstacles"];
                for (const obs in obstacles) {
                    myCanvas.drawBlock(obstacles[obs][0], obstacles[obs][1]);
                }

                // Robots
                let locations = data["locations"];
                for (const loc in locations) {
                    myCanvas.fillStyle = loc;
                    myCanvas.drawBlock(locations[loc][0], locations[loc][1]);
                }
            }

            // Textfield textUnits
            function UpdateUnits(){
                var text = "Available units:<br>"
                let locations = data["locations"];
                let destinations = data["destinations"];
                for (const loc in locations) {
                    text += "<span style =\"color:\""+loc+">"+loc+"</span>: <span>"+JSON.stringify(locations[loc])+"</span><br>";
                }
                document.getElementById("textUnits").innerHTML = text;
            }

            // Textfield textQueue
            function UpdateQueue(){
                var text = "Queue:<br>"

                let destinations = data["destinations"];
                for (const dest in destinations) {
                    const destination = destinations[dest];
                    for (let i = 1; i < destination.length; i++) {
                        text += "<span>" + dest + "</span>: <span>" + JSON.stringify(destination[i - 1]) + "</span> -> <span>" + JSON.stringify(destination[i]) + "</span><br>";
                    }
                }
                document.getElementById("textQueue").innerHTML = text;
            }

            // Input
            function SendLocation() {
                let value1 = document.getElementById("inputSendUnit").value;
                let value2 = document.getElementById("inputSendLocation").value;
                console.log("Sent: " + value1 + ", " + value2 + " - {\"type\":0, \""+value1+"\": ["+value2+"]}");
                ws.send("{\"type\":0, \"name\":\""+value1+"\", \"to\":["+value2+"]}");
            }

            function SendPickup() {
                let value1 = document.getElementById("inputPickupLocation").value;
                let value2 = document.getElementById("inputDeliverLocation").value;
                console.log("Sent: " + value1 + ", " + value2 + " - {\"type\":1, \"from\": ["+value1+"], \"to\": ["+value2+"]}");
                ws.send("{\"type\":1, \"from\": ["+value1+"], \"to\": ["+value2+"]}");
            }
            
            
            function Stop() {
                console.log("Sent: Stop");
                ws.send("{\"type\":2}");
            }
        </script>
    </body>
</html>